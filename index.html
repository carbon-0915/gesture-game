<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹åŠ¿æ‰“åœ°é¼  - MediaPipeæ‰‹åŠ¿è¯†åˆ«ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- MediaPipe Hands åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e5e7eb; overflow: hidden; }
        
        .phone-frame {
            border: 12px solid #111827;
            border-radius: 3.5rem;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.4);
            background-color: #fff;
            overflow: hidden;
            width: 100%;
            max-width: 380px;
            height: 780px;
            position: relative;
            margin: 20px auto;
        }

        .screen { height: 100%; display: none; flex-direction: column; background: #fff; }
        .screen.active { display: flex; }

        .game-container {
            position: relative;
            flex: 1;
            background: #111;
            overflow: hidden;
        }

        #camera-feed {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            filter: brightness(0.9) contrast(1.1);
        }

        #game-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
        }

        #buffer-canvas { display: none; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* è®¾ç½®é¡µæŒ‰é’®æ ·å¼ */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .setting-item:active { background-color: #f9fafb; }

        input[type="range"] {
            accent-color: #10b981;
        }

        /* åŠ¨ç”»è¿‡æ¸¡ */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* è¿”å›æŒ‰é’®ç»Ÿä¸€æ ·å¼ */
        .back-btn {
            background-color: #10b981;
            color: white;
            font-weight: bold;
            padding: 12px 32px;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        .back-btn:hover {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(16, 185, 129, 0.4);
        }
        .back-btn:active {
            transform: translateY(0);
        }

        /* é¦–é¡µèƒŒæ™¯æ¸å˜ */
        .home-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .phone-frame {
                max-width: 100%;
                height: 100vh;
                height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œé¿å…ç§»åŠ¨ç«¯æµè§ˆå™¨åœ°å€æ å½±å“ */
                border: 0;
                border-radius: 0;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="phone-frame">
        <!-- 0. æ¸¸æˆä»‹ç»é¦–é¡µ -->
        <div id="screen-home" class="screen active">
            <div class="flex-1 home-bg flex flex-col items-center justify-center p-8 text-center">
                <div class="w-24 h-24 bg-white/20 rounded-3xl flex items-center justify-center mb-6 animate-pop">
                    <span class="text-6xl">ğŸ¹</span>
                </div>
                <h1 class="text-3xl font-black text-white mb-3">æ‰‹åŠ¿æ‰“åœ°é¼ </h1>
                <p class="text-white/80 text-sm mb-2">Motion Capture Whack-a-Mole</p>
                <div class="bg-white/10 rounded-2xl p-4 mb-8 mt-4">
                    <p class="text-white/90 text-xs leading-relaxed">
                        ğŸ¯ <strong>æ¸¸æˆç©æ³•</strong><br>
                        é€šè¿‡æ‘„åƒå¤´æ•æ‰æ‚¨çš„æ‰‹éƒ¨åŠ¨ä½œ<br>
                        å¯¹å‡†åœ°é¼ æ¡†æŒ¥æ‰‹å³å¯å‡»æ‰“å¾—åˆ†<br><br>
                        âš¡ <strong>æ¸¸æˆç‰¹è‰²</strong><br>
                        â€¢ å®æ—¶åŠ¨ä½œæ•æ‰è¯†åˆ«<br>
                        â€¢ å¤šç§éš¾åº¦çº§åˆ«å¯é€‰<br>
                        â€¢ çµæ•åº¦è‡ªç”±è°ƒèŠ‚<br><br>
                        ğŸ’¡ <strong>æ¸©é¦¨æç¤º</strong><br>
                        è¯·åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸­æ¸¸ç©<br>
                        æ¸¸æˆéœ€è¦ä½¿ç”¨æ‘„åƒå¤´æƒé™
                    </p>
                </div>
                <button onclick="showScreen('game')" class="w-full bg-white text-purple-600 font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform mb-4">
                    ğŸ® å¼€å§‹æ¸¸æˆ
                </button>
                <div class="flex gap-4 w-full">
                    <button onclick="showScreen('settings-main')" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl active:scale-95 transition-transform">
                        âš™ï¸ è®¾ç½®
                    </button>
                    <button onclick="showScreen('stats')" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl active:scale-95 transition-transform">
                        ğŸ“Š æ’è¡Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- 1. æ¸¸æˆä¸»ç•Œé¢ -->
        <div id="screen-game" class="screen">
            <div class="p-4 pt-6 flex justify-between items-center border-b z-20">
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Active System</span>
                    <h1 class="font-bold text-sm text-gray-800">åŠ¨ä½œæ•æ‰æ‰“åœ°é¼ </h1>
                </div>
                <div class="bg-green-50 px-4 py-1.5 rounded-full border border-green-100">
                    <span id="current-score" class="text-green-600 font-black text-sm">0</span>
                </div>
            </div>
            
            <div class="game-container">
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="game-canvas"></canvas>
                <canvas id="buffer-canvas"></canvas>
                
                <div id="game-overlay" class="absolute inset-0 bg-black/40 flex items-center justify-center p-6 text-center z-30 transition-opacity duration-300">
                    <div class="glass-panel p-8 shadow-2xl w-full animate-pop">
                        <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <span class="text-3xl">ğŸ®</span>
                        </div>
                        <h2 id="overlay-title" class="text-xl font-bold mb-2 text-gray-900">å‡†å¤‡æˆ˜æ–—</h2>
                        <p id="overlay-desc" class="text-gray-500 mb-8 text-xs leading-relaxed">å¯¹ç€åœ°é¼ æ¡†æŒ¥æ‰‹å³å¯å‡»æ‰“<br>è¯·ç¡®ä¿åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸­æ¸¸ç©</p>
                        <button id="start-btn" class="w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">
                            å¯åŠ¨æ„Ÿåº”å™¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨å¯¼èˆª -->
            <div class="p-4 bg-white border-t flex justify-around items-center">
                <button onclick="showScreen('home')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ </span>
                    <span class="text-[10px] font-bold mt-1">é¦–é¡µ</span>
                </button>
                <button onclick="showScreen('game')" class="flex flex-col items-center text-green-600">
                    <span class="text-xl">ğŸ¯</span>
                    <span class="text-[10px] font-bold mt-1">æ¸¸æˆ</span>
                </button>
                <button onclick="showScreen('settings-main')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">âš™ï¸</span>
                    <span class="text-[10px] font-bold mt-1">è®¾ç½®</span>
                </button>
                <button onclick="showScreen('stats')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ“Š</span>
                    <span class="text-[10px] font-bold mt-1">æ’è¡Œ</span>
                </button>
            </div>
        </div>

        <!-- 2. è®¾ç½®ä¸»é¡µ -->
        <div id="screen-settings-main" class="screen bg-gray-50">
            <div class="p-6 border-b bg-white flex items-center">
                <h1 class="font-bold text-lg">ç³»ç»Ÿè®¾ç½®</h1>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="mt-4 bg-white border-y">
                    <div onclick="showScreen('settings-difficulty')" class="setting-item">
                        <div class="flex items-center">
                            <span class="mr-3">âš¡</span>
                            <span class="font-medium text-gray-700">éš¾åº¦è®¾ç½®</span>
                        </div>
                        <span class="text-gray-400 text-sm" id="label-difficulty">ä¸­ç­‰ ></span>
                    </div>
                    <div onclick="showScreen('settings-calibration')" class="setting-item">
                        <div class="flex items-center">
                            <span class="mr-3">ğŸ‘ï¸</span>
                            <span class="font-medium text-gray-700">æ„Ÿåº”æ ¡å‡†</span>
                        </div>
                        <span class="text-gray-400 text-sm">çµæ•åº¦ ></span>
                    </div>
                    <div class="setting-item">
                        <div class="flex items-center">
                            <span class="mr-3">ğŸ”Š</span>
                            <span class="font-medium text-gray-700">éŸ³æ•ˆåé¦ˆ</span>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 rounded">
                    </div>
                </div>
                <!-- è¿”å›æŒ‰é’®æ”¾åœ¨é¡µé¢ä¸­é—´ -->
                <div class="p-6 flex justify-center">
                    <button onclick="showScreen('home')" class="back-btn">
                        â† è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
            <!-- åº•éƒ¨å¯¼èˆª -->
            <div class="p-4 bg-white border-t flex justify-around items-center">
                <button onclick="showScreen('home')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ </span>
                    <span class="text-[10px] font-bold mt-1">é¦–é¡µ</span>
                </button>
                <button onclick="showScreen('game')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ¯</span>
                    <span class="text-[10px] font-bold mt-1">æ¸¸æˆ</span>
                </button>
                <button onclick="showScreen('settings-main')" class="flex flex-col items-center text-green-600">
                    <span class="text-xl">âš™ï¸</span>
                    <span class="text-[10px] font-bold mt-1">è®¾ç½®</span>
                </button>
                <button onclick="showScreen('stats')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ“Š</span>
                    <span class="text-[10px] font-bold mt-1">æ’è¡Œ</span>
                </button>
            </div>
        </div>

        <!-- 3. éš¾åº¦è¯¦æƒ…é¡µ -->
        <div id="screen-settings-difficulty" class="screen bg-white">
            <div class="p-6 border-b flex items-center justify-center">
                <h1 class="font-bold text-lg">éš¾åº¦çº§åˆ«</h1>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-widest block mb-4">åœ°é¼ å‡ºç°é¢‘ç‡</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setDifficulty(2500, 'ç®€å•')" class="diff-btn py-3 border-2 border-gray-100 rounded-xl text-sm font-bold">ç®€å•</button>
                        <button onclick="setDifficulty(1500, 'ä¸­ç­‰')" class="diff-btn py-3 border-2 border-green-500 bg-green-50 text-green-700 rounded-xl text-sm font-bold">ä¸­ç­‰</button>
                        <button onclick="setDifficulty(800, 'ç–¯ç‹‚')" class="diff-btn py-3 border-2 border-gray-100 rounded-xl text-sm font-bold">ç–¯ç‹‚</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-widest block mb-4">å­˜æ´»æ—¶é—´ (ç§’)</label>
                    <input type="range" id="input-life" min="1000" max="5000" step="500" value="3000" class="w-full">
                    <div class="flex justify-between text-[10px] text-gray-400 mt-2 font-bold">
                        <span>æé€Ÿ</span><span>æ ‡å‡†</span><span>æ‚ é—²</span>
                    </div>
                </div>
                <p class="text-xs text-gray-400 leading-relaxed bg-gray-50 p-4 rounded-xl">
                    æç¤ºï¼šè®¾ç½®è¶Šé«˜ï¼Œç³»ç»Ÿå¯¹åŠ¨ä½œè¯†åˆ«çš„è¦æ±‚è¶Šé«˜ã€‚å¦‚æœè§‰å¾—éš¾ä»¥å‡»ä¸­ï¼Œè¯·å°è¯•"æ‚ é—²"æ¨¡å¼ã€‚
                </p>
                <!-- è¿”å›æŒ‰é’®æ”¾åœ¨é¡µé¢ä¸­é—´ -->
                <div class="flex justify-center pt-4">
                    <button onclick="showScreen('settings-main')" class="back-btn">
                        â† è¿”å›è®¾ç½®
                    </button>
                </div>
            </div>
            <!-- åº•éƒ¨å¯¼èˆª -->
            <div class="p-4 bg-white border-t flex justify-around items-center">
                <button onclick="showScreen('home')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ </span>
                    <span class="text-[10px] font-bold mt-1">é¦–é¡µ</span>
                </button>
                <button onclick="showScreen('game')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ¯</span>
                    <span class="text-[10px] font-bold mt-1">æ¸¸æˆ</span>
                </button>
                <button onclick="showScreen('settings-main')" class="flex flex-col items-center text-green-600">
                    <span class="text-xl">âš™ï¸</span>
                    <span class="text-[10px] font-bold mt-1">è®¾ç½®</span>
                </button>
                <button onclick="showScreen('stats')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ“Š</span>
                    <span class="text-[10px] font-bold mt-1">æ’è¡Œ</span>
                </button>
            </div>
        </div>

        <!-- 4. æ ¡å‡†è¯¦æƒ…é¡µ -->
        <div id="screen-settings-calibration" class="screen bg-white">
            <div class="p-6 border-b flex items-center justify-center">
                <h1 class="font-bold text-lg">æ„Ÿåº”æ ¡å‡†</h1>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <!-- å®æ—¶é¢„è§ˆåŒºåŸŸï¼ˆåŸºäº MediaPipe æ‰‹åŠ¿è¯†åˆ«ï¼‰ -->
                <div id="preview-container" class="aspect-video bg-black rounded-2xl overflow-hidden mb-4 relative border-4 border-transparent transition-all duration-200">
                    <video id="calibration-video" autoplay playsinline class="w-full h-full object-cover" style="transform: scaleX(-1);"></video>
                    <canvas id="calibration-canvas" class="absolute inset-0 w-full h-full"></canvas>
                    <div id="calibration-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center px-4">
                        <span class="text-white/70 text-xs font-semibold mb-2">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨é¢„è§ˆ</span>
                        <span class="text-white/50 text-[10px] leading-relaxed">
                            ä¼¸å‡ºä¸€åªæ‰‹ï¼Œä¿æŒåœ¨ç”»é¢ä¸­å¤®<br>
                            ç³»ç»Ÿä¼šæ˜¾ç¤ºæ‰‹éƒ¨éª¨æ¶å’Œé£ŸæŒ‡æŒ‡å°–ä½ç½®
                        </span>
                    </div>
                </div>
                
                <!-- å¯åŠ¨/åœæ­¢é¢„è§ˆæŒ‰é’® -->
                <div class="flex gap-2 mb-4">
                    <button id="start-calibration-btn" onclick="startCalibrationPreview()" class="flex-1 py-2 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors text-sm">
                        ğŸ“· å¯åŠ¨é¢„è§ˆ
                    </button>
                    <button id="stop-calibration-btn" onclick="stopCalibrationPreview()" class="flex-1 py-2 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors text-sm hidden">
                        â¹ï¸ åœæ­¢é¢„è§ˆ
                    </button>
                </div>
                
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest block mb-4">å‡»ä¸­åˆ¤å®šèŒƒå›´</label>
                <input type="range" id="input-threshold" min="20" max="80" value="40" class="w-full">
                <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                    <span>ç²¾ç¡®å‡»æ‰“ï¼ˆèŒƒå›´å°ï¼‰</span>
                    <span>å½“å‰: <span id="val-threshold">40</span> åƒç´ </span>
                    <span>å®½æ¾å‡»æ‰“ï¼ˆèŒƒå›´å¤§ï¼‰</span>
                </div>
                <p class="text-[10px] text-center text-gray-500 mt-2 font-semibold">
                    ğŸ’¡ å½“å‰é£ŸæŒ‡åœ†åœˆåŠå¾„ â‰ˆ æ¸¸æˆå‡»ä¸­èŒƒå›´
                </p>
                
                <!-- æ‰‹åŠ¿è¯†åˆ«çŠ¶æ€ -->
                <div class="mt-4 p-3 bg-gray-50 rounded-xl">
                    <p class="text-xs text-gray-500 mb-2">ğŸ“Š æ‰‹åŠ¿è¯†åˆ«çŠ¶æ€</p>
                    <div class="flex justify-between text-[10px]">
                        <span class="text-gray-400">å½“å‰è¯†åˆ«ï¼š</span>
                        <span id="calibration-status" class="font-bold text-green-600">æœªå¼€å§‹é¢„è§ˆ</span>
                    </div>
                    <div class="flex justify-between text-[10px] mt-1">
                        <span class="text-gray-400">æ£€æµ‹åˆ°çš„æ‰‹æ•°ï¼š</span>
                        <span id="calibration-hand-count" class="font-bold text-blue-600">0</span>
                    </div>
                </div>
                
                <p class="text-[10px] text-center text-gray-400 mt-4 italic leading-relaxed">
                    ğŸ’¡ æç¤ºï¼šåœ¨é¢„è§ˆä¸­ä¼¸å‡ºä¸€åªæ‰‹ï¼Œå¯¹ç€å±å¹•åšå‡ºæŒ¥æ‰“åŠ¨ä½œï¼›<br>
                    è°ƒæ•´â€œå‡»ä¸­åˆ¤å®šèŒƒå›´â€ï¼Œç¡®ä¿é£ŸæŒ‡åœ†åœˆåˆšå¥½è¦†ç›–åœ°é¼ æ¡†æ—¶å¯ä»¥å‡»ä¸­ã€‚
                </p>
                
                <!-- è¿”å›æŒ‰é’®æ”¾åœ¨é¡µé¢ä¸­é—´ -->
                <div class="flex justify-center mt-6">
                    <button onclick="stopCalibrationPreview(); showScreen('settings-main')" class="back-btn">
                        â† è¿”å›è®¾ç½®
                    </button>
                </div>
            </div>
            <!-- åº•éƒ¨å¯¼èˆª -->
            <div class="p-4 bg-white border-t flex justify-around items-center">
                <button onclick="showScreen('home')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ </span>
                    <span class="text-[10px] font-bold mt-1">é¦–é¡µ</span>
                </button>
                <button onclick="showScreen('game')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ¯</span>
                    <span class="text-[10px] font-bold mt-1">æ¸¸æˆ</span>
                </button>
                <button onclick="showScreen('settings-main')" class="flex flex-col items-center text-green-600">
                    <span class="text-xl">âš™ï¸</span>
                    <span class="text-[10px] font-bold mt-1">è®¾ç½®</span>
                </button>
                <button onclick="showScreen('stats')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ“Š</span>
                    <span class="text-[10px] font-bold mt-1">æ’è¡Œ</span>
                </button>
            </div>
        </div>

        <!-- 5. ç»Ÿè®¡/æ’è¡Œ -->
        <div id="screen-stats" class="screen bg-gray-50">
            <div class="p-6 border-b bg-white flex items-center justify-center">
                <h1 class="font-bold text-lg">è£èª‰æ®¿å ‚</h1>
            </div>
            <div class="flex-1 p-6 overflow-y-auto">
                <div class="bg-white rounded-3xl p-6 shadow-sm mb-4 border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Personal Best</p>
                        <p class="text-3xl font-black text-gray-900" id="best-score">0</p>
                    </div>
                    <div class="text-4xl">ğŸ‘‘</div>
                </div>
                <div id="score-history" class="space-y-2">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                    <div class="p-4 bg-white rounded-2xl border border-gray-100 flex justify-between items-center opacity-50">
                        <span class="text-xs font-bold text-gray-400">æš‚æ— æ¯”èµ›æ•°æ®</span>
                        <span class="text-xs text-gray-300"># -</span>
                    </div>
                </div>
                <!-- è¿”å›æŒ‰é’®æ”¾åœ¨é¡µé¢ä¸­é—´ -->
                <div class="flex justify-center mt-8">
                    <button onclick="showScreen('home')" class="back-btn">
                        â† è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
            <!-- åº•éƒ¨å¯¼èˆª -->
            <div class="p-4 bg-white border-t flex justify-around items-center">
                <button onclick="showScreen('home')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ </span>
                    <span class="text-[10px] font-bold mt-1">é¦–é¡µ</span>
                </button>
                <button onclick="showScreen('game')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">ğŸ¯</span>
                    <span class="text-[10px] font-bold mt-1">æ¸¸æˆ</span>
                </button>
                <button onclick="showScreen('settings-main')" class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                    <span class="text-xl">âš™ï¸</span>
                    <span class="text-[10px] font-bold mt-1">è®¾ç½®</span>
                </button>
                <button onclick="showScreen('stats')" class="flex flex-col items-center text-green-600">
                    <span class="text-xl">ğŸ“Š</span>
                    <span class="text-[10px] font-bold mt-1">æ’è¡Œ</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const buffer = document.getElementById('buffer-canvas');
        const bCtx = buffer.getContext('2d');
        
        // æ ¸å¿ƒæ¸¸æˆçŠ¶æ€
        let score = 0;
        let gameActive = false;
        let moles = [];
        let bestScore = 0;
        
        // æ‰‹éƒ¨è¿½è¸ªçŠ¶æ€
        let hands = null;
        let handLandmarks = [];
        let lastHandPositions = [];
        
        // æ¸¸æˆå†å²è®°å½•ï¼ˆä¿å­˜åœ¨å†…å­˜ä¸­ï¼‰
        let gameHistory = [];

        // è®¾ç½®å‚æ•°
        let config = {
            spawnInterval: 1500,
            moleLife: 3000,
            // ä½¿ç”¨æ‰‹åŠ¿ç‰ˆåï¼Œthreshold è¡¨ç¤ºâ€œå‡»ä¸­åˆ¤å®šèŒƒå›´â€ï¼ˆåƒç´ åŠå¾„ï¼‰ï¼Œè€Œä¸æ˜¯åƒç´ è¿åŠ¨é˜ˆå€¼
            threshold: 40,
            difficultyLabel: 'ä¸­ç­‰'
        };

        // UI å¯¼èˆª
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');
            
            // å¦‚æœç¦»å¼€æ¸¸æˆå±ï¼Œåˆ™ç¡®ä¿æ¸¸æˆåœæ­¢
            if(screenId !== 'game') {
                stopGame();
            }
        }

        function setDifficulty(interval, label) {
            config.spawnInterval = interval;
            config.difficultyLabel = label;
            document.getElementById('label-difficulty').innerText = label + ' >';
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'bg-green-50', 'text-green-700');
                btn.classList.add('border-gray-100');
                if(btn.innerText === label) {
                    btn.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                    btn.classList.remove('border-gray-100');
                }
            });
        }

        // åˆå§‹åŒ– MediaPipe Hands
        function initMediaPipeHands() {
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onHandResults);
        }
        
        // å¤„ç†æ‰‹éƒ¨æ£€æµ‹ç»“æœ
        function onHandResults(results) {
            if (!gameActive) return;
            
            handLandmarks = results.multiHandLandmarks || [];
            
            // ç»˜åˆ¶æ‰‹éƒ¨éª¨æ¶
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (handLandmarks.length > 0) {
                for (const landmarks of handLandmarks) {
                    // ç»˜åˆ¶æ‰‹éƒ¨è¿æ¥çº¿
                    drawHandConnections(landmarks);
                    
                    // ä½¿ç”¨é£ŸæŒ‡æŒ‡å°–ï¼ˆç´¢å¼•8ï¼‰è¿›è¡Œç¢°æ’æ£€æµ‹
                    const indexTip = landmarks[8];
                    const x = (1 - indexTip.x) * canvas.width; // é•œåƒ
                    const y = indexTip.y * canvas.height;
                    
                    // ç»˜åˆ¶æŒ‡å°–ä½ç½®
                    ctx.fillStyle = '#10b981';
                    ctx.beginPath();
                    ctx.arc(x, y, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // æ£€æµ‹å‡»ä¸­
                    checkHit(x, y);
                }
            }
            
            // ç»˜åˆ¶åœ°é¼ 
            drawMoles();
        }
        
        // ç»˜åˆ¶æ‰‹éƒ¨è¿æ¥çº¿
        function drawHandConnections(landmarks) {
            const connections = [
                [0, 1], [1, 2], [2, 3], [3, 4],  // æ‹‡æŒ‡
                [0, 5], [5, 6], [6, 7], [7, 8],  // é£ŸæŒ‡
                [0, 9], [9, 10], [10, 11], [11, 12],  // ä¸­æŒ‡
                [0, 13], [13, 14], [14, 15], [15, 16],  // æ— åæŒ‡
                [0, 17], [17, 18], [18, 19], [19, 20],  // å°æŒ‡
                [5, 9], [9, 13], [13, 17]  // æ‰‹æŒ
            ];
            
            ctx.strokeStyle = 'rgba(16, 185, 129, 0.6)';
            ctx.lineWidth = 2;
            
            for (const [i, j] of connections) {
                const x1 = (1 - landmarks[i].x) * canvas.width;
                const y1 = landmarks[i].y * canvas.height;
                const x2 = (1 - landmarks[j].x) * canvas.width;
                const y2 = landmarks[j].y * canvas.height;
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶å…³é”®ç‚¹
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (const landmark of landmarks) {
                const x = (1 - landmark.x) * canvas.width;
                const y = landmark.y * canvas.height;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // åˆå§‹åŒ–æ‘„åƒå¤´å¹¶å¯åŠ¨æ‰‹åŠ¿æ£€æµ‹
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: {ideal: 380}, height: {ideal: 600}, facingMode: "user" }
                });
                video.srcObject = stream;
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                });
                
                // åˆå§‹åŒ– MediaPipe Hands
                initMediaPipeHands();
                
                return true;
            } catch (err) {
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæ‘„åƒå¤´æƒé™ã€‚');
                return false;
            }
        }

        function setupCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            buffer.width = 80;
            buffer.height = 60;
        }

        function spawnMole() {
            if (!gameActive) return;
            moles.push({
                x: Math.random() * (canvas.width - 120) + 60,
                y: Math.random() * (canvas.height - 120) + 60,
                size: 80,
                life: config.moleLife,
                maxLife: config.moleLife,
                hit: false,
                popScale: 0
            });
            setTimeout(spawnMole, config.spawnInterval);
        }

        // æ‰‹åŠ¿æ£€æµ‹å¾ªç¯
        async function detectHands() {
            if (!gameActive || !hands) return;
            
            if (video.readyState >= 2) {
                await hands.send({image: video});
            }
            
            requestAnimationFrame(detectHands);
        }
        
        // ç»˜åˆ¶åœ°é¼ 
        function drawMoles() {
            moles = moles.filter(m => {
                m.life -= 16;
                if (m.life > 0) {
                    if(m.popScale < 1) m.popScale += 0.1;

                    ctx.save();
                    ctx.translate(m.x + m.size/2, m.y + m.size/2);
                    ctx.scale(m.popScale, m.popScale);

                    ctx.strokeStyle = m.hit ? '#f87171' : 'rgba(255,255,255,0.8)';
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';
                    ctx.strokeRect(-m.size/2, -m.size/2, m.size, m.size);
                    
                    ctx.font = "50px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(m.hit ? "ğŸ’¥" : "ğŸ¹", 0, 0);
                    
                    ctx.restore();
                    return true;
                }
                return false;
            });
        }

        function checkHit(x, y) {
            const r = config.threshold; // ä½œä¸ºâ€œå‡»ä¸­åˆ¤å®šèŒƒå›´â€ä½¿ç”¨
            moles.forEach(m => {
                if (!m.hit && x > m.x - r && x < m.x + m.size + r && y > m.y - r && y < m.y + m.size + r) {
                    m.hit = true;
                    m.life = 500; // çˆ†ç‚¸åŠ¨ç”»æŒç»­æ—¶é—´
                    score += 10;
                    document.getElementById('current-score').innerText = score;
                }
            });
        }

        // å¤‡ç”¨ç»˜åˆ¶å¾ªç¯ï¼ˆå½“æ‰‹åŠ¿æ£€æµ‹æœªæ¿€æ´»æ—¶ä½¿ç”¨ï¼‰
        function draw() {
            if (!gameActive) return;
            
            // å¦‚æœæ‰‹åŠ¿æ£€æµ‹æ­£åœ¨è¿è¡Œï¼Œä¸éœ€è¦å•ç‹¬çš„ç»˜åˆ¶å¾ªç¯
            // å› ä¸º onHandResults ä¼šå¤„ç†ç»˜åˆ¶
            if (hands && handLandmarks.length > 0) {
                requestAnimationFrame(draw);
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawMoles();
            requestAnimationFrame(draw);
        }

        function stopGame() {
            gameActive = false;
            document.getElementById('game-overlay').classList.remove('hidden');
        }
        
        // æ ¹æ®åˆ†æ•°è·å–è¯„ä»·
        function getScoreRating(score) {
            if (score >= 150) return { text: 'ğŸ† ä¼ å¥‡', color: 'text-purple-600' };
            if (score >= 120) return { text: 'â­ ä¼˜ç§€', color: 'text-yellow-600' };
            if (score >= 90) return { text: 'ğŸ‘ è‰¯å¥½', color: 'text-green-600' };
            if (score >= 60) return { text: 'ğŸ“ˆ ä¸­ç­‰', color: 'text-blue-600' };
            if (score >= 30) return { text: 'ğŸ’ª éœ€åŠªåŠ›', color: 'text-orange-600' };
            return { text: 'ğŸŒ± æ–°æ‰‹', color: 'text-gray-500' };
        }
        
        // ä¿å­˜æ¸¸æˆè®°å½•åˆ°å†…å­˜
        function saveGameRecord(finalScore) {
            const rating = getScoreRating(finalScore);
            const record = {
                score: finalScore,
                date: new Date().toLocaleString('zh-CN'),
                difficulty: config.difficultyLabel,
                rating: rating.text,
                ratingColor: rating.color
            };
            gameHistory.push(record);
            // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•ï¼ˆæ’åºåä¼šå–å‰10æ¡æ˜¾ç¤ºï¼‰
            if (gameHistory.length > 20) {
                gameHistory = gameHistory.slice(-20);
            }
            updateScoreHistory();
        }
        
        // æ›´æ–°æ’è¡Œæ¦œæ˜¾ç¤º
        function updateScoreHistory() {
            const historyContainer = document.getElementById('score-history');
            if (gameHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="p-4 bg-white rounded-2xl border border-gray-100 flex justify-between items-center opacity-50">
                        <span class="text-xs font-bold text-gray-400">æš‚æ— æ¯”èµ›æ•°æ®</span>
                        <span class="text-xs text-gray-300"># -</span>
                    </div>
                `;
            } else {
                // æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åº
                const sortedHistory = [...gameHistory].sort((a, b) => b.score - a.score);
                // åªæ˜¾ç¤ºå‰10æ¡
                const top10 = sortedHistory.slice(0, 10);
                
                historyContainer.innerHTML = top10.map((record, index) => {
                    const rating = getScoreRating(record.score);
                    return `
                    <div class="p-4 bg-white rounded-2xl border border-gray-100 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-400 w-6">#${index + 1}</span>
                            <div>
                                <span class="text-sm font-bold text-gray-800">${record.score} åˆ†</span>
                                <span class="text-xs ${rating.color} ml-2 font-semibold">${rating.text}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-400">${record.date}</span>
                        </div>
                    </div>
                `;
                }).join('');
            }
        }

        document.getElementById('start-btn').onclick = async () => {
            if (await initCamera()) {
                setupCanvas();
                document.getElementById('game-overlay').classList.add('hidden');
                score = 0;
                moles = []; // æ¸…ç©ºåœ°é¼ æ•°ç»„
                document.getElementById('current-score').innerText = "0";
                gameActive = true;
                
                // å¯åŠ¨åœ°é¼ ç”Ÿæˆ
                spawnMole();
                
                // å¯åŠ¨æ‰‹åŠ¿æ£€æµ‹å¾ªç¯
                detectHands();
                
                // å¯åŠ¨å¤‡ç”¨ç»˜åˆ¶å¾ªç¯ï¼ˆå½“æ‰‹åŠ¿æœªæ£€æµ‹åˆ°æ—¶ç»˜åˆ¶åœ°é¼ ï¼‰
                draw();
                
                // æ¸¸æˆæ—¶é•¿15ç§’
                setTimeout(() => {
                    gameActive = false;
                    document.getElementById('game-overlay').classList.remove('hidden');
                    document.getElementById('overlay-title').innerText = "æˆ˜æ–—æŠ¥å‘Š";
                    document.getElementById('overlay-desc').innerHTML = `æœ€ç»ˆå¾—åˆ†: <span class="text-2xl font-black text-green-600">${score}</span> åˆ†`;
                    document.getElementById('start-btn').innerText = "å†æ¥ä¸€å±€";
                    
                    // ä¿å­˜æ¸¸æˆè®°å½•
                    saveGameRecord(score);
                    
                    if(score > bestScore) {
                        bestScore = score;
                        document.getElementById('best-score').innerText = bestScore;
                    }
                }, 15000);
            }
        };

        document.getElementById('input-life').oninput = (e) => config.moleLife = parseInt(e.target.value);
        document.getElementById('input-threshold').oninput = (e) => {
            config.threshold = parseInt(e.target.value);
            document.getElementById('val-threshold').innerText = config.threshold;
            // å¦‚æœæ ¡å‡†é¢„è§ˆæ­£åœ¨è¿è¡Œï¼Œè§¦å‘é‡ç»˜ä»¥æ›´æ–°åœ†åœˆåŠå¾„
            if (calibrationActive && calibrationHands && calibrationVideo.readyState >= 2) {
                calibrationHands.send({ image: calibrationVideo });
            }
        };

        // ========== æ‰‹åŠ¿ç‰ˆæ ¡å‡†é¢„è§ˆåŠŸèƒ½ ==========
        const calibrationVideo = document.getElementById('calibration-video');
        const calibrationCanvas = document.getElementById('calibration-canvas');
        const calibrationCtx = calibrationCanvas.getContext('2d');

        let calibrationStream = null;
        let calibrationActive = false;
        let calibrationHands = null;

        const calibrationStatus = document.getElementById('calibration-status');
        const calibrationHandCount = document.getElementById('calibration-hand-count');

        // æ ¡å‡†é¡µé¢çš„åœ°é¼ å›¾æ ‡çŠ¶æ€
        let calibrationMole = {
            x: 0,
            y: 0,
            size: 80,
            hit: false,
            hitAnimationTime: 0
        };

        function initCalibrationHands() {
            calibrationHands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            calibrationHands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            calibrationHands.onResults(onCalibrationResults);
        }

        function drawCalibrationHand(landmarks) {
            const width = calibrationCanvas.width;
            const height = calibrationCanvas.height;

            const connections = [
                [0, 1], [1, 2], [2, 3], [3, 4],
                [0, 5], [5, 6], [6, 7], [7, 8],
                [0, 9], [9, 10], [10, 11], [11, 12],
                [0, 13], [13, 14], [14, 15], [15, 16],
                [0, 17], [17, 18], [18, 19], [19, 20],
                [5, 9], [9, 13], [13, 17]
            ];

            calibrationCtx.strokeStyle = 'rgba(16, 185, 129, 0.6)';
            calibrationCtx.lineWidth = 2;

            for (const [i, j] of connections) {
                const x1 = (1 - landmarks[i].x) * width;
                const y1 = landmarks[i].y * height;
                const x2 = (1 - landmarks[j].x) * width;
                const y2 = landmarks[j].y * height;

                calibrationCtx.beginPath();
                calibrationCtx.moveTo(x1, y1);
                calibrationCtx.lineTo(x2, y2);
                calibrationCtx.stroke();
            }

            calibrationCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (const landmark of landmarks) {
                const x = (1 - landmark.x) * width;
                const y = landmark.y * height;
                calibrationCtx.beginPath();
                calibrationCtx.arc(x, y, 3, 0, Math.PI * 2);
                calibrationCtx.fill();
            }

            // é£ŸæŒ‡æŒ‡å°–ä½ç½®å’Œåœ†åœˆåŠå¾„
            const tip = landmarks[8];
            const tx = (1 - tip.x) * width;
            const ty = tip.y * height;
            
            // ç»˜åˆ¶åœ†åœˆåŠå¾„ï¼ˆä½¿ç”¨config.thresholdä½œä¸ºåŠå¾„ï¼‰
            const radius = config.threshold;
            calibrationCtx.strokeStyle = '#10b981';
            calibrationCtx.lineWidth = 2;
            calibrationCtx.setLineDash([5, 5]); // è™šçº¿
            calibrationCtx.beginPath();
            calibrationCtx.arc(tx, ty, radius, 0, Math.PI * 2);
            calibrationCtx.stroke();
            calibrationCtx.setLineDash([]); // æ¢å¤å®çº¿
            
            // ç»˜åˆ¶æŒ‡å°–ä¸­å¿ƒç‚¹
            calibrationCtx.fillStyle = '#10b981';
            calibrationCtx.beginPath();
            calibrationCtx.arc(tx, ty, 10, 0, Math.PI * 2);
            calibrationCtx.fill();
            
            // è¿”å›æŒ‡å°–ä½ç½®ç”¨äºç¢°æ’æ£€æµ‹
            return { x: tx, y: ty, radius: radius };
        }

        function drawCalibrationMole() {
            const m = calibrationMole;
            
            // ç»˜åˆ¶åœ°é¼ è¾¹æ¡†
            calibrationCtx.strokeStyle = m.hit ? '#f87171' : 'rgba(255,255,255,0.8)';
            calibrationCtx.lineWidth = 4;
            calibrationCtx.lineCap = 'round';
            calibrationCtx.strokeRect(m.x - m.size/2, m.y - m.size/2, m.size, m.size);
            
            // ç»˜åˆ¶åœ°é¼ å›¾æ ‡æˆ–çˆ†ç‚¸æ•ˆæœ
            calibrationCtx.font = "50px Arial";
            calibrationCtx.textAlign = "center";
            calibrationCtx.textBaseline = "middle";
            
            if (m.hit && m.hitAnimationTime > 0) {
                // çˆ†ç‚¸æ•ˆæœ
                const scale = 1 + (500 - m.hitAnimationTime) / 500 * 0.5; // æ”¾å¤§åŠ¨ç”»
                calibrationCtx.save();
                calibrationCtx.translate(m.x, m.y);
                calibrationCtx.scale(scale, scale);
                calibrationCtx.fillText("ğŸ’¥", 0, 0);
                calibrationCtx.restore();
                m.hitAnimationTime -= 16; // æ¯å¸§å‡å°‘16ms
                
                if (m.hitAnimationTime <= 0) {
                    m.hit = false;
                }
            } else {
                // æ­£å¸¸åœ°é¼ å›¾æ ‡
                calibrationCtx.fillText("ğŸ¹", m.x, m.y);
            }
        }

        function checkCalibrationHit(fingerTip) {
            const m = calibrationMole;
            const r = fingerTip.radius;
            
            // æ£€æµ‹é£ŸæŒ‡åœ†åœˆæ˜¯å¦ä¸åœ°é¼ æ£€æµ‹èŒƒå›´é‡åˆ
            // åœ°é¼ çš„æ£€æµ‹èŒƒå›´ï¼šåœ°é¼ ä¸­å¿ƒ Â± (size/2 + r)
            const moleLeft = m.x - m.size/2 - r;
            const moleRight = m.x + m.size/2 + r;
            const moleTop = m.y - m.size/2 - r;
            const moleBottom = m.y + m.size/2 + r;
            
            const fingerX = fingerTip.x;
            const fingerY = fingerTip.y;
            
            // æ£€æŸ¥æŒ‡å°–ä¸­å¿ƒç‚¹æ˜¯å¦åœ¨åœ°é¼ æ£€æµ‹èŒƒå›´å†…
            if (fingerX >= moleLeft && fingerX <= moleRight && 
                fingerY >= moleTop && fingerY <= moleBottom) {
                if (!m.hit) {
                    m.hit = true;
                    m.hitAnimationTime = 500; // çˆ†ç‚¸åŠ¨ç”»æŒç»­500ms
                }
            } else {
                // ç¦»å¼€æ£€æµ‹åŒºï¼Œæ¢å¤åœ°é¼ å›¾æ ‡
                if (m.hit && m.hitAnimationTime <= 0) {
                    m.hit = false;
                }
            }
        }

        function onCalibrationResults(results) {
            if (!calibrationActive) return;

            calibrationCtx.clearRect(0, 0, calibrationCanvas.width, calibrationCanvas.height);

            const handsLandmarks = results.multiHandLandmarks || [];
            const count = handsLandmarks.length;

            calibrationStatus.innerText = count > 0 ? 'å·²è¯†åˆ«åˆ°æ‰‹éƒ¨' : 'æœªè¯†åˆ«åˆ°æ‰‹éƒ¨';
            calibrationHandCount.innerText = count.toString();

            // ç»˜åˆ¶åœ°é¼ å›¾æ ‡
            drawCalibrationMole();

            if (count > 0) {
                // ç»˜åˆ¶æ‰‹éƒ¨éª¨æ¶å’Œé£ŸæŒ‡åœ†åœˆï¼Œå¹¶è·å–æŒ‡å°–ä½ç½®
                const fingerTips = [];
                handsLandmarks.forEach(landmarks => {
                    const tip = drawCalibrationHand(landmarks);
                    if (tip) {
                        fingerTips.push(tip);
                    }
                });
                
                // æ£€æµ‹ç¢°æ’
                fingerTips.forEach(tip => {
                    checkCalibrationHit(tip);
                });
            }
        }

        // å¯åŠ¨æ ¡å‡†é¢„è§ˆï¼ˆåŸºäº MediaPipe æ‰‹åŠ¿è¯†åˆ«ï¼‰
        async function startCalibrationPreview() {
            try {
                calibrationStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: {ideal: 320}, height: {ideal: 180}, facingMode: "user" }
                });
                calibrationVideo.srcObject = calibrationStream;

                calibrationVideo.onloadedmetadata = () => {
                    calibrationCanvas.width = calibrationVideo.videoWidth;
                    calibrationCanvas.height = calibrationVideo.videoHeight;

                    // åˆå§‹åŒ–åœ°é¼ ä½ç½®
                    calibrationMole.x = calibrationCanvas.width / 2;
                    calibrationMole.y = calibrationCanvas.height / 2;
                    calibrationMole.hit = false;
                    calibrationMole.hitAnimationTime = 0;

                    calibrationActive = true;

                    document.getElementById('calibration-placeholder').classList.add('hidden');
                    document.getElementById('start-calibration-btn').classList.add('hidden');
                    document.getElementById('stop-calibration-btn').classList.remove('hidden');

                    if (!calibrationHands) {
                        initCalibrationHands();
                    }

                    runCalibrationLoop();
                };
            } catch (err) {
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæ‘„åƒå¤´æƒé™ã€‚');
            }
        }

        // åœæ­¢æ ¡å‡†é¢„è§ˆ
        function stopCalibrationPreview() {
            calibrationActive = false;

            if (calibrationStream) {
                calibrationStream.getTracks().forEach(track => track.stop());
                calibrationStream = null;
            }

            calibrationVideo.srcObject = null;
            calibrationCtx.clearRect(0, 0, calibrationCanvas.width, calibrationCanvas.height);

            // é‡ç½®åœ°é¼ çŠ¶æ€
            calibrationMole.x = 0;
            calibrationMole.y = 0;
            calibrationMole.hit = false;
            calibrationMole.hitAnimationTime = 0;

            document.getElementById('calibration-placeholder').classList.remove('hidden');
            document.getElementById('start-calibration-btn').classList.remove('hidden');
            document.getElementById('stop-calibration-btn').classList.add('hidden');

            calibrationStatus.innerText = 'æœªå¼€å§‹é¢„è§ˆ';
            calibrationHandCount.innerText = '0';
        }

        async function runCalibrationLoop() {
            if (!calibrationActive || !calibrationHands) return;

            if (calibrationVideo.readyState >= 2) {
                await calibrationHands.send({ image: calibrationVideo });
            }

            requestAnimationFrame(runCalibrationLoop);
        }

        window.onload = setupCanvas;
    </script>
</body>
</html>
